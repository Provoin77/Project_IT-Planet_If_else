{% extends 'base.html' %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

{% block content %}
  <h2>–ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
  <p><strong>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> {{ current_user.username }}</p>
  <p><strong>Email:</strong> {{ current_user.email }}</p>
  <p><strong>–†–æ–ª—å:</strong> –£—á–∞—Å—Ç–Ω–∏–∫</p>
  <p><a href="{{ url_for('edit_profile') }}">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</a></p>
  <p><a href="{{ url_for('my_events') }}">–ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a></p>
  


  <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ -->
  <button id="friends-toggle" aria-label="–î—Ä—É–∑—å—è">ü§ù</button>

  <!-- –í—ã–ª–µ–∑–∞—é—â–µ–µ –º–µ–Ω—é –¥—Ä—É–∑–µ–π -->
  <div id="friends-panel">
    <div class="panel-header">
      <h3>–î—Ä—É–∑—å—è</h3>
      <button id="friends-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    </div>

    <div class="panel-body">
      <!-- 1) –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
      <section>
        <h4>–ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h4>
        <input type="text"
               id="friend-search"
               placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email">
        <div id="friend-search-results"></div>
      </section>

      <!-- 2) –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏ -->
      <section>
        <h4>–í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏</h4>
        <ul>
          {% set incoming = current_user.received_requests
                            |selectattr("status","equalto","pending")
                            |list %}
          {% if incoming %}
            {% for fr in incoming %}
              <li>
                {{ fr.requester.username }} ({{ fr.requester.email }})
                <form method="post"
                      action="{{ url_for('respond_friend_request',
                                         friendship_id=fr.id) }}"
                      class="inline-form">
                  <button name="action" value="accept">–ü—Ä–∏–Ω—è—Ç—å</button>
                  <button name="action" value="reject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </form>
              </li>
            {% endfor %}
          {% else %}
            <li>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫.</li>
          {% endif %}
        </ul>
      </section>

      <!-- 3) –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–æ–º -->
      <section>
        <h4>–ú–æ–∏ –¥—Ä—É–∑—å—è</h4>
        <input type="text"
               id="friends-filter"
               placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email">
        <ul id="friends-list">
          {% set all_fr = current_user.sent_requests + current_user.received_requests %}
          {% set accepted = all_fr
                             |selectattr("status","equalto","accepted")
                             |list %}
          {% if accepted %}
            {% for fr in accepted %}
              {% set u = fr.requester if fr.requester_id!=current_user.id else fr.receiver %}
              <li data-username="{{ u.username|lower }}"
                  data-email="{{ u.email|lower }}">
                <a href="{{ url_for('friend_detail', user_id=u.id) }}">
                  {{ u.username }}
                </a>
                <span class="email">({{ u.email }})</span>
              </li>
            {% endfor %}
          {% else %}
            <li>–£ –≤–∞—Å –Ω–µ—Ç –¥—Ä—É–∑–µ–π.</li>
          {% endif %}
        </ul>
      </section>
    </div>

    <div class="form-row">
      <label for="region">–†–µ–≥–∏–æ–Ω:</label>
      <input type="text"
             name="region"
             id="region"
             value="{{ current_user.region or '' }}"
             placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–æ—Å–∫–≤–∞">
    </div>
    <!-- 4) –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ -->
    <button id="privacy-toggle" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏">‚öôÔ∏è</button>
    <div id="privacy-controls">
      <button id="privacy-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
      <h4>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h4>
      <form id="privacy-form"
            method="post"
            action="{{ url_for('set_privacy') }}">
        <select name="privacy">
          <option value="public"  {% if current_user.event_privacy=='public'  %}selected{% endif %}>
            –í—Å–µ–º
          </option>
          <option value="friends" {% if current_user.event_privacy=='friends' %}selected{% endif %}>
            –¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è–º
          </option>
          <option value="private" {% if current_user.event_privacy=='private' %}selected{% endif %}>
            –ù–∏–∫–æ–º—É
          </option>
        </select>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  // --- Toggle –ø–∞–Ω–µ–ª–∏ –¥—Ä—É–∑–µ–π ---
  const friendsToggle = document.getElementById('friends-toggle');
  const panel         = document.getElementById('friends-panel');
  const friendsClose  = document.getElementById('friends-close');

  // –ö–ª–∏–∫ –ø–æ –∑–Ω–∞—á–∫—É ¬´–î—Ä—É–∑—å—è¬ª
  friendsToggle.addEventListener('click', () => {
    const opening = !panel.classList.contains('open');
    panel.classList.toggle('open');
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∑–Ω–∞—á–æ–∫, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    friendsToggle.style.display = opening ? 'none' : '';
  });

  // –ö–ª–∏–∫ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É
  friendsClose.addEventListener('click', () => {
    panel.classList.remove('open');
    friendsToggle.style.display = '';
  });

  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ URL
  if (window.location.search.includes('open=friends')) {
    panel.classList.add('open');
    friendsToggle.style.display = 'none';
    const url = new URL(window.location);
    url.searchParams.delete('open');
    window.history.replaceState({}, '', url);
  }

  // --- AJAX‚Äë–ø–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ + –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ ---
  let timer;
  document.getElementById('friend-search').addEventListener('input', e => {
    clearTimeout(timer);
    const q = e.target.value.trim();
    const out = document.getElementById('friend-search-results');
    if (!q) {
      out.innerHTML = '';
      return;
    }
    timer = setTimeout(() => {
      fetch('/participants/search?q=' + encodeURIComponent(q), {
        credentials: 'same-origin'
      })
      .then(r => r.json())
      .then(list => {
        out.innerHTML = '';
        if (!list.length) {
          out.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
          return;
        }
        list.forEach(u => {
          const div = document.createElement('div');
          div.classList.add('search-item');

          // –∫–Ω–æ–ø–∫–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏–ª–∏ —Å—Ç–∞—Ç—É—Å
          if (u.friendship === 'none' || u.friendship === 'rejected') {
            const label = (u.friendship === 'rejected') ? '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å' : '–î–æ–±–∞–≤–∏—Ç—å';
            div.innerHTML = `
              <span>${u.username} (${u.email})</span>
              <button data-id="${u.id}">${label}</button>
            `;
            div.querySelector('button').onclick = () => {
              fetch('/friends/send_request/' + u.id, {
                method: 'POST',
                credentials: 'same-origin'
              }).then(() => {
                div.innerHTML = `<span>${u.username} (${u.email})</span>–ó–∞–ø—Ä–æ—à–µ–Ω–æ`;
              });
            };
          }
          else if (u.friendship === 'pending') {
            div.innerHTML = `<span>${u.username} (${u.email})</span>–ó–∞–ø—Ä–æ—à–µ–Ω–æ`;
          }
          else { // accepted
            div.innerHTML = `<span>${u.username} (${u.email})</span>–í –¥—Ä—É–∑—å—è—Ö`;
          }

          out.appendChild(div);
        });
      });
    }, 300);
  });

  // --- –§–∏–ª—å—Ç—Ä —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π ---
  document.getElementById('friends-filter')
    .addEventListener('input', e => {
      const q = e.target.value.toLowerCase().trim();
      document.querySelectorAll('#friends-list li').forEach(li => {
        if (!q) {
          li.style.display = '';
          return;
        }
        const uname = li.dataset.username,
              email = li.dataset.email;
        li.style.display = (uname.includes(q) || email.includes(q))
                           ? '' : 'none';
      });
    });

  // --- –ü–∞–Ω–µ–ª—å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ ---
  const privBox = document.getElementById('privacy-controls');
  document.getElementById('privacy-toggle')
          .addEventListener('click', () => privBox.classList.toggle('open'));
  document.getElementById('privacy-close')
          .addEventListener('click', () => privBox.classList.remove('open'));
  document.getElementById('privacy-form')
          .addEventListener('submit', e => {
    e.preventDefault();
    const form = e.target,
          data = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      body: data,
      credentials: 'same-origin'
    }).then(() => privBox.classList.remove('open'));
  });
</script>


<script src="{{ url_for('static', filename='notifications.js') }}"></script>

{% endblock %}
